{
  "name": "qr-code",
  "dependencies": [
    "radix-ui",
    "qrcode"
  ],
  "devDependencies": [
    "@types/qrcode"
  ],
  "registryDependencies": [
    "@diceui/use-lazy-ref"
  ],
  "files": [
    {
      "path": "ui/qr-code.tsx",
      "content": "\"use client\";\r\n\r\nimport { Slot as SlotPrimitive } from \"radix-ui\";\r\nimport * as React from \"react\";\r\nimport { useComposedRefs } from \"@/lib/compose-refs\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useLazyRef } from \"@/registry/bases/radix/hooks/use-lazy-ref\";\r\n\r\nconst ROOT_NAME = \"QRCode\";\r\nconst CANVAS_NAME = \"QRCodeCanvas\";\r\nconst SVG_NAME = \"QRCodeSvg\";\r\nconst IMAGE_NAME = \"QRCodeImage\";\r\nconst SKELETON_NAME = \"QRCodeSkeleton\";\r\n\r\ntype QRCodeLevel = \"L\" | \"M\" | \"Q\" | \"H\";\r\n\r\ninterface QRCodeCanvasOpts {\r\n  errorCorrectionLevel: QRCodeLevel;\r\n  type?: \"image/png\" | \"image/jpeg\" | \"image/webp\";\r\n  quality?: number;\r\n  margin?: number;\r\n  color?: {\r\n    dark: string;\r\n    light: string;\r\n  };\r\n  width?: number;\r\n  rendererOpts?: {\r\n    quality?: number;\r\n  };\r\n}\r\n\r\ninterface StoreState {\r\n  dataUrl: string | null;\r\n  svgString: string | null;\r\n  isGenerating: boolean;\r\n  error: Error | null;\r\n  generationKey: string;\r\n}\r\n\r\ninterface Store {\r\n  subscribe: (callback: () => void) => () => void;\r\n  getState: () => StoreState;\r\n  setState: <K extends keyof StoreState>(key: K, value: StoreState[K]) => void;\r\n  setStates: (updates: Partial<StoreState>) => void;\r\n  notify: () => void;\r\n}\r\n\r\ninterface QRCodeContextValue {\r\n  value: string;\r\n  size: number;\r\n  margin: number;\r\n  level: QRCodeLevel;\r\n  backgroundColor: string;\r\n  foregroundColor: string;\r\n  canvasRef: React.RefObject<HTMLCanvasElement | null>;\r\n}\r\n\r\nconst StoreContext = React.createContext<Store | null>(null);\r\n\r\nfunction useStore<T>(selector: (state: StoreState) => T): T {\r\n  const store = React.useContext(StoreContext);\r\n  if (!store) {\r\n    throw new Error(`\\`useQRCode\\` must be used within \\`${ROOT_NAME}\\``);\r\n  }\r\n\r\n  const getSnapshot = React.useCallback(\r\n    () => selector(store.getState()),\r\n    [store, selector],\r\n  );\r\n\r\n  return React.useSyncExternalStore(store.subscribe, getSnapshot, getSnapshot);\r\n}\r\n\r\nconst QRCodeContext = React.createContext<QRCodeContextValue | null>(null);\r\n\r\nfunction useQRCodeContext(consumerName: string) {\r\n  const context = React.useContext(QRCodeContext);\r\n  if (!context) {\r\n    throw new Error(`\\`${consumerName}\\` must be used within \\`${ROOT_NAME}\\``);\r\n  }\r\n  return context;\r\n}\r\n\r\ninterface QRCodeProps extends Omit<React.ComponentProps<\"div\">, \"onError\"> {\r\n  value: string;\r\n  size?: number;\r\n  level?: QRCodeLevel;\r\n  margin?: number;\r\n  quality?: number;\r\n  backgroundColor?: string;\r\n  foregroundColor?: string;\r\n  onError?: (error: Error) => void;\r\n  onGenerated?: () => void;\r\n  asChild?: boolean;\r\n}\r\n\r\nfunction QRCode(props: QRCodeProps) {\r\n  const {\r\n    value,\r\n    size = 200,\r\n    level = \"M\",\r\n    margin = 1,\r\n    quality = 0.92,\r\n    backgroundColor = \"#ffffff\",\r\n    foregroundColor = \"#000000\",\r\n    onError,\r\n    onGenerated,\r\n    className,\r\n    style,\r\n    asChild,\r\n    ...rootProps\r\n  } = props;\r\n\r\n  const canvasRef = React.useRef<HTMLCanvasElement>(null);\r\n\r\n  const listenersRef = useLazyRef(() => new Set<() => void>());\r\n  const stateRef = useLazyRef<StoreState>(() => ({\r\n    dataUrl: null,\r\n    svgString: null,\r\n    isGenerating: false,\r\n    error: null,\r\n    generationKey: \"\",\r\n  }));\r\n\r\n  const store = React.useMemo<Store>(() => {\r\n    return {\r\n      subscribe: (cb) => {\r\n        listenersRef.current.add(cb);\r\n        return () => listenersRef.current.delete(cb);\r\n      },\r\n      getState: () => stateRef.current,\r\n      setState: (key, value) => {\r\n        if (Object.is(stateRef.current[key], value)) return;\r\n        stateRef.current[key] = value;\r\n        store.notify();\r\n      },\r\n      setStates: (updates) => {\r\n        let hasChanged = false;\r\n\r\n        for (const key of Object.keys(updates) as Array<keyof StoreState>) {\r\n          const value = updates[key];\r\n          if (value !== undefined && !Object.is(stateRef.current[key], value)) {\r\n            Object.assign(stateRef.current, { [key]: value });\r\n            hasChanged = true;\r\n          }\r\n        }\r\n\r\n        if (hasChanged) {\r\n          store.notify();\r\n        }\r\n      },\r\n      notify: () => {\r\n        for (const cb of listenersRef.current) {\r\n          cb();\r\n        }\r\n      },\r\n    };\r\n  }, [listenersRef, stateRef]);\r\n\r\n  const canvasOpts = React.useMemo<QRCodeCanvasOpts>(\r\n    () => ({\r\n      errorCorrectionLevel: level,\r\n      type: \"image/png\",\r\n      quality,\r\n      margin,\r\n      color: {\r\n        dark: foregroundColor,\r\n        light: backgroundColor,\r\n      },\r\n      width: size,\r\n    }),\r\n    [level, margin, foregroundColor, backgroundColor, size, quality],\r\n  );\r\n\r\n  const generationKey = React.useMemo(() => {\r\n    if (!value) return \"\";\r\n\r\n    return JSON.stringify({\r\n      value,\r\n      size,\r\n      level,\r\n      margin,\r\n      quality,\r\n      foregroundColor,\r\n      backgroundColor,\r\n    });\r\n  }, [value, level, margin, foregroundColor, backgroundColor, size, quality]);\r\n\r\n  const onQRCodeGenerate = React.useCallback(\r\n    async (targetGenerationKey: string) => {\r\n      if (!value || !targetGenerationKey) return;\r\n\r\n      const currentState = store.getState();\r\n      if (\r\n        currentState.isGenerating ||\r\n        currentState.generationKey === targetGenerationKey\r\n      )\r\n        return;\r\n\r\n      store.setStates({\r\n        isGenerating: true,\r\n        error: null,\r\n      });\r\n\r\n      try {\r\n        const QRCode = (await import(\"qrcode\")).default;\r\n\r\n        let dataUrl: string | null = null;\r\n\r\n        try {\r\n          dataUrl = await QRCode.toDataURL(value, canvasOpts);\r\n        } catch {\r\n          dataUrl = null;\r\n        }\r\n\r\n        if (canvasRef.current) {\r\n          await QRCode.toCanvas(canvasRef.current, value, canvasOpts);\r\n        }\r\n\r\n        const svgString = await QRCode.toString(value, {\r\n          errorCorrectionLevel: canvasOpts.errorCorrectionLevel,\r\n          margin: canvasOpts.margin,\r\n          color: canvasOpts.color,\r\n          width: canvasOpts.width,\r\n          type: \"svg\",\r\n        });\r\n\r\n        store.setStates({\r\n          dataUrl,\r\n          svgString,\r\n          isGenerating: false,\r\n          generationKey: targetGenerationKey,\r\n        });\r\n\r\n        onGenerated?.();\r\n      } catch (error) {\r\n        const parsedError =\r\n          error instanceof Error\r\n            ? error\r\n            : new Error(\"Failed to generate QR code\");\r\n        store.setStates({\r\n          error: parsedError,\r\n          isGenerating: false,\r\n        });\r\n        onError?.(parsedError);\r\n      }\r\n    },\r\n    [value, canvasOpts, store, onError, onGenerated],\r\n  );\r\n\r\n  const contextValue = React.useMemo<QRCodeContextValue>(\r\n    () => ({\r\n      value,\r\n      size,\r\n      level,\r\n      margin,\r\n      backgroundColor,\r\n      foregroundColor,\r\n      canvasRef,\r\n    }),\r\n    [value, size, backgroundColor, foregroundColor, level, margin],\r\n  );\r\n\r\n  React.useLayoutEffect(() => {\r\n    if (generationKey) {\r\n      const rafId = requestAnimationFrame(() => {\r\n        onQRCodeGenerate(generationKey);\r\n      });\r\n\r\n      return () => cancelAnimationFrame(rafId);\r\n    }\r\n  }, [generationKey, onQRCodeGenerate]);\r\n\r\n  const RootPrimitive = asChild ? SlotPrimitive.Slot : \"div\";\r\n\r\n  return (\r\n    <StoreContext.Provider value={store}>\r\n      <QRCodeContext.Provider value={contextValue}>\r\n        <RootPrimitive\r\n          data-slot=\"qr-code\"\r\n          {...rootProps}\r\n          className={cn(className, \"relative flex flex-col items-center gap-2\")}\r\n          style={\r\n            {\r\n              \"--qr-code-size\": `${size}px`,\r\n              ...style,\r\n            } as React.CSSProperties\r\n          }\r\n        />\r\n      </QRCodeContext.Provider>\r\n    </StoreContext.Provider>\r\n  );\r\n}\r\n\r\ninterface QRCodeCanvasProps extends React.ComponentProps<\"canvas\"> {\r\n  asChild?: boolean;\r\n}\r\n\r\nfunction QRCodeCanvas(props: QRCodeCanvasProps) {\r\n  const { asChild, className, ref, ...canvasProps } = props;\r\n\r\n  const context = useQRCodeContext(CANVAS_NAME);\r\n  const generationKey = useStore((state) => state.generationKey);\r\n\r\n  const composedRef = useComposedRefs(ref, context.canvasRef);\r\n\r\n  const CanvasPrimitive = asChild ? SlotPrimitive.Slot : \"canvas\";\r\n\r\n  return (\r\n    <CanvasPrimitive\r\n      data-slot=\"qr-code-canvas\"\r\n      {...canvasProps}\r\n      ref={composedRef}\r\n      width={context.size}\r\n      height={context.size}\r\n      className={cn(\r\n        \"relative max-h-(--qr-code-size) max-w-(--qr-code-size)\",\r\n        !generationKey && \"invisible\",\r\n        className,\r\n      )}\r\n    />\r\n  );\r\n}\r\n\r\ninterface QRCodeSvgProps extends React.ComponentProps<\"div\"> {\r\n  asChild?: boolean;\r\n}\r\n\r\nfunction QRCodeSvg(props: QRCodeSvgProps) {\r\n  const { asChild, className, style, ...svgProps } = props;\r\n\r\n  const context = useQRCodeContext(SVG_NAME);\r\n  const svgString = useStore((state) => state.svgString);\r\n\r\n  if (!svgString) return null;\r\n\r\n  const SvgPrimitive = asChild ? SlotPrimitive.Slot : \"div\";\r\n\r\n  return (\r\n    <SvgPrimitive\r\n      data-slot=\"qr-code-svg\"\r\n      {...svgProps}\r\n      className={cn(\r\n        \"relative max-h-(--qr-code-size) max-w-(--qr-code-size)\",\r\n        className,\r\n      )}\r\n      style={{ width: context.size, height: context.size, ...style }}\r\n      dangerouslySetInnerHTML={{ __html: svgString }}\r\n    />\r\n  );\r\n}\r\n\r\ninterface QRCodeImageProps extends React.ComponentProps<\"img\"> {\r\n  asChild?: boolean;\r\n}\r\n\r\nfunction QRCodeImage(props: QRCodeImageProps) {\r\n  const { alt = \"QR Code\", asChild, className, ...imageProps } = props;\r\n\r\n  const context = useQRCodeContext(IMAGE_NAME);\r\n  const dataUrl = useStore((state) => state.dataUrl);\r\n\r\n  if (!dataUrl) return null;\r\n\r\n  const ImagePrimitive = asChild ? SlotPrimitive.Slot : \"img\";\r\n\r\n  return (\r\n    <ImagePrimitive\r\n      data-slot=\"qr-code-image\"\r\n      {...imageProps}\r\n      src={dataUrl}\r\n      alt={alt}\r\n      width={context.size}\r\n      height={context.size}\r\n      className={cn(\r\n        \"relative max-h-(--qr-code-size) max-w-(--qr-code-size)\",\r\n        className,\r\n      )}\r\n    />\r\n  );\r\n}\r\n\r\ninterface QRCodeDownloadProps extends React.ComponentProps<\"button\"> {\r\n  filename?: string;\r\n  format?: \"png\" | \"svg\";\r\n  asChild?: boolean;\r\n}\r\n\r\nfunction QRCodeDownload(props: QRCodeDownloadProps) {\r\n  const {\r\n    filename = \"qrcode\",\r\n    format = \"png\",\r\n    asChild,\r\n    className,\r\n    children,\r\n    ...buttonProps\r\n  } = props;\r\n\r\n  const dataUrl = useStore((state) => state.dataUrl);\r\n  const svgString = useStore((state) => state.svgString);\r\n\r\n  const onClick = React.useCallback(\r\n    (event: React.MouseEvent<HTMLButtonElement>) => {\r\n      buttonProps.onClick?.(event);\r\n      if (event.defaultPrevented) return;\r\n\r\n      const link = document.createElement(\"a\");\r\n\r\n      if (format === \"png\" && dataUrl) {\r\n        link.href = dataUrl;\r\n        link.download = `${filename}.png`;\r\n      } else if (format === \"svg\" && svgString) {\r\n        const blob = new Blob([svgString], { type: \"image/svg+xml\" });\r\n        link.href = URL.createObjectURL(blob);\r\n        link.download = `${filename}.svg`;\r\n      } else {\r\n        return;\r\n      }\r\n\r\n      document.body.appendChild(link);\r\n      link.click();\r\n      document.body.removeChild(link);\r\n\r\n      if (format === \"svg\" && svgString) {\r\n        URL.revokeObjectURL(link.href);\r\n      }\r\n    },\r\n    [dataUrl, svgString, filename, format, buttonProps.onClick],\r\n  );\r\n\r\n  const ButtonPrimitive = asChild ? SlotPrimitive.Slot : \"button\";\r\n\r\n  return (\r\n    <ButtonPrimitive\r\n      type=\"button\"\r\n      data-slot=\"qr-code-download\"\r\n      {...buttonProps}\r\n      className={cn(\"max-w-(--qr-code-size)\", className)}\r\n      onClick={onClick}\r\n    >\r\n      {children ?? `Download ${format.toUpperCase()}`}\r\n    </ButtonPrimitive>\r\n  );\r\n}\r\n\r\ninterface QRCodeOverlayProps extends React.ComponentProps<\"div\"> {\r\n  asChild?: boolean;\r\n}\r\n\r\nfunction QRCodeOverlay(props: QRCodeOverlayProps) {\r\n  const { asChild, className, ...overlayProps } = props;\r\n\r\n  const OverlayPrimitive = asChild ? SlotPrimitive.Slot : \"div\";\r\n\r\n  return (\r\n    <OverlayPrimitive\r\n      data-slot=\"qr-code-overlay\"\r\n      {...overlayProps}\r\n      className={cn(\r\n        \"absolute top-1/2 left-1/2 flex -translate-x-1/2 -translate-y-1/2 items-center justify-center rounded-sm bg-background\",\r\n        className,\r\n      )}\r\n    />\r\n  );\r\n}\r\n\r\ninterface QRCodeSkeletonProps extends React.ComponentProps<\"div\"> {\r\n  asChild?: boolean;\r\n}\r\n\r\nfunction QRCodeSkeleton(props: QRCodeSkeletonProps) {\r\n  const { asChild, className, style, ...skeletonProps } = props;\r\n\r\n  const context = useQRCodeContext(SKELETON_NAME);\r\n  const dataUrl = useStore((state) => state.dataUrl);\r\n  const svgString = useStore((state) => state.svgString);\r\n  const generationKey = useStore((state) => state.generationKey);\r\n\r\n  const isLoaded = dataUrl || svgString || generationKey;\r\n\r\n  if (isLoaded) return null;\r\n\r\n  const SkeletonPrimitive = asChild ? SlotPrimitive.Slot : \"div\";\r\n\r\n  return (\r\n    <SkeletonPrimitive\r\n      data-slot=\"qr-code-skeleton\"\r\n      {...skeletonProps}\r\n      className={cn(\r\n        \"absolute max-h-(--qr-code-size) max-w-(--qr-code-size) animate-pulse bg-accent\",\r\n        className,\r\n      )}\r\n      style={{\r\n        width: context.size,\r\n        height: context.size,\r\n        ...style,\r\n      }}\r\n    />\r\n  );\r\n}\r\n\r\nexport {\r\n  QRCode,\r\n  QRCodeCanvas,\r\n  QRCodeSvg,\r\n  QRCodeImage,\r\n  QRCodeOverlay,\r\n  QRCodeSkeleton,\r\n  QRCodeDownload,\r\n  //\r\n  useStore as useQRCode,\r\n  //\r\n  type QRCodeProps,\r\n};\r\n",
      "type": "registry:ui",
      "target": ""
    }
  ],
  "type": "registry:ui"
}